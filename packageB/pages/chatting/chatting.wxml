<!-- pages/Secondary/pages/chatting/chatting.wxml -->
<wxs module="dateFormat" src="../../../filter/dateFormat.wxs"></wxs>
<scroll-view class='chat' id="chat" refresher-triggered="{{triggered}}" bindrefresherpulling="onPulling" bindrefresherrefresh="onRefresh" bindrefresherrestore="onRestore" bindrefresherabort="onAbort" refresher-enabled="{{true}}" refresher-threshold="{{20}}" scroll-y="{{true}}" scroll-into-view="{{toLast}}">
  <view class="chat-content">
    <view class="load-more">下拉加载更多</view>
    <view class="message-item-box" id="msg-item-{{index}}" wx:for="{{contactMessages.messageList}}" wx:key="ID">
      <view class="msg-time">{{dateFormat.getChatDate(item.time)}}</view>
      <view class="message-item-inner msg-{{item.flow}}">
        <view class="read-status{{!item.isPeerRead ? ' unreaded' : ''}}" wx:if="{{item.flow === 'out'}}">{{item.isPeerRead ? '已读' : '未读'}}</view>
        <image class="chat-head" src="https://wx.qlogo.cn/mmhead/Q3auHgzwzM6RjnYYXVNIU7LYGZ637YaJt3g31xWZUiaEZNI0wYTEVibw/0"></image>
        <view class="message-detail">
          <view class="msg-type-text" wx:if="{{item.type === 'TIMTextElem'}}">{{item.payload.text}}</view>
          <image class="msg-type-image" style="width:{{item.payload.imageInfoArray[1].width * 2}}rpx;" mode="widthFix" wx:if="{{item.type === 'TIMImageElem'}}" src="{{item.payload.imageInfoArray[1].imageUrl}}"></image>
          <view class="msg-type-voice" data-voice="{{item}}" wx:if="{{item.type === 'TIMSoundElem'}}" bindtap="handlePlayVoice">
            <image mode="widthFix" wx:if="{{!item.playing}}" class="sound-img" src="../../images/sound-{{item.flow}}.jpg"></image>
            <image mode="widthFix" wx:if="{{item.playing}}" class="sound-img" src="../../images/sound-playing-{{item.flow}}.gif"></image>
            <view class="voice-duration-text">{{item.payload.second}}"</view>
            <!-- <view>{{item.playing}}</view> -->
          </view>
          <view class="msg-type-video" wx:if="{{item.type === 'TIMVideoFileElem'}}">
            <video class="msg-video" src="{{item.payload.videoUrl}}"></video>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>
<view class='chat-footer'>
  <view class="send-type-box">
    <view class='send-voice-btn' bindtap='handleToggleAudio'>
      <image wx:if="{{isInputAudio}}" src="../../images/keyboard.jpg"></image>
      <image wx:if="{{!isInputAudio}}" src="../../images/voice.jpg"></image>
    </view>
    <view class='send-text-box'>
      <input cursor-spacing="{{50}}" wx:if="{{!isInputAudio}}" class='input' bindfocus="bindFocusInput" bindblur="bindBlurInput" bindinput="bindKeyInput" value="{{inputValue}}" />
      <view wx:if="{{isInputAudio}}" catch:touchmove="handleTouchMove" catch:longpress="handleStartRecordVoice" bind:touchend="handleEndRecordVoice" class="audio-ipt">{{voiceStatusStr}}</view>
    </view>
    <view class='send-btn'>
      <image wx:if="{{!isInputText}}" bindtap="handleSelectFile" src="../../images/add.jpg"></image>
      <view class="btn-box" wx:if="{{isInputText}}" bindtap='handleSendText'>发送</view>
    </view>
  </view>
  <view class="select-file-box" wx:if="{{selectFileVisible}}">
    <view class="file-type-box n1">
      <image class="file-icon-img" bindtap="handleSendImg" mode="widthFix" src="../../images/img-icon.jpg"></image>
      <view>照片</view>
    </view>
    <view class="file-type-box">
      <image class="file-icon-img" bindtap="handleSendVideo" mode="widthFix" src="../../images/video-icon.jpg"></image>
      <view>视频</view>
    </view>
  </view>
  <view class="bottom-box"></view>
</view>